// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ===== ENUMS NATIVOS DE POSTGRESQL =====

enum AdminRole {
    SUPER_ADMIN
    SUPERVISOR
    OPERATOR
}

enum WorkerStatus {
    ACTIVE
    INACTIVE
    SUSPENDED
}

enum DeviceStatus {
    ACTIVE
    INACTIVE
    BLOCKED
}

enum AttendanceType {
    ENTRY
    EXIT
}

enum RecordStatus {
    PENDING
    ACCEPTED
    REJECTED
    SUSPICIOUS
}

enum LoginQRStatus {
    PENDING
    USED
    EXPIRED
}

enum ExceptionCodeStatus {
    PENDING
    USED
    EXPIRED
}

enum ConfigLevel {
    GLOBAL
    DEPOT
    WORKER
}

enum ExceptionReason {
    HOLIDAY
    SPECIAL_EVENT
    OVERTIME
    MAINTENANCE
    EMERGENCY
}

// ===== AUTENTICACIÓN =====

model Admin {
    id        String    @id @default(uuid()) @db.Uuid
    username  String    @unique @db.VarChar(50)
    email     String    @unique @db.VarChar(255)
    password  String    @db.VarChar(255) // Hash de contraseña (bcrypt)
    firstName String    @db.VarChar(100)
    lastName  String    @db.VarChar(100)
    role      AdminRole @default(SUPERVISOR)
    isActive  Boolean   @default(true)
    lastLogin DateTime? @db.Timestamptz(3)
    createdAt DateTime  @default(now()) @db.Timestamptz(3)
    updatedAt DateTime  @updatedAt @db.Timestamptz(3)

    // Relaciones
    generatedLoginQRs WorkerLoginQR[]
    exceptionCodes    ExceptionCode[]

    @@index([email])
    @@index([username])
    @@index([isActive])
    @@map("admins")
}

model WorkerLoginQR {
    id          String        @id @default(uuid()) @db.Uuid
    qrToken     String        @unique @db.VarChar(255)
    shortCode   String?       @unique @db.VarChar(6) // Código de 6 dígitos
    status      LoginQRStatus @default(PENDING)
    expiresAt   DateTime?     @db.Timestamptz(3)
    usedAt      DateTime?     @db.Timestamptz(3)
    deviceInfo  Json? // JSONB para info del dispositivo
    createdAt   DateTime      @default(now()) @db.Timestamptz(3)
    updatedAt   DateTime      @updatedAt @db.Timestamptz(3)

    // Relaciones
    workerId String @db.Uuid
    worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)
    adminId  String @db.Uuid
    admin    Admin  @relation(fields: [adminId], references: [id], onDelete: Cascade)

    @@index([workerId])
    @@index([adminId])
    @@index([status])
    @@index([expiresAt])
    @@map("worker_login_qrs")
}

// ===== ENTIDADES PRINCIPALES =====

model Depot {
    id              String   @id @default(uuid()) @db.Uuid
    name            String   @db.VarChar(200)
    address         String?  @db.Text
    latitude        Decimal  @db.Decimal(10, 8) // Más preciso para GPS
    longitude       Decimal  @db.Decimal(11, 8) // Más preciso para GPS
    radius          Int      @default(100) @db.SmallInt // Radio en metros
    secret          String   @unique @db.VarChar(255) // Clave criptográfica
    secretUpdatedAt DateTime @default(now()) @db.Timestamptz(3)
    isActive        Boolean  @default(true)
    createdAt       DateTime @default(now()) @db.Timestamptz(3)
    updatedAt       DateTime @updatedAt @db.Timestamptz(3)

    // Relaciones
    workers       Worker[]
    attendances   Attendance[]
    qrCodes       AttendanceQRCode[]
    workSchedules WorkSchedule[]

    @@index([isActive])
    @@index([name])
    @@map("depots")
}

model Worker {
    id           String       @id @default(uuid()) @db.Uuid
    employeeId   String       @unique @db.VarChar(50) // ID empleado externo
    firstName    String       @db.VarChar(100)
    lastName     String       @db.VarChar(100)
    email        String?      @unique @db.VarChar(255)
    phone        String?      @db.VarChar(20)
    profilePhoto String?      @db.Text // URL/path de foto
    status       WorkerStatus @default(ACTIVE)

    // Autenticación
    isAuthenticated Boolean   @default(false)
    lastLoginAt     DateTime? @db.Timestamptz(3)

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    // Relación con depot
    depotId String @db.Uuid
    depot   Depot  @relation(fields: [depotId], references: [id], onDelete: Restrict)

    // Relaciones
    devices             Device[]
    attendances         Attendance[]
    attendanceRecords   AttendanceRecord[]
    loginQRs            WorkerLoginQR[]
    exceptionCodes      ExceptionCode[]
    scheduleAssignments WorkerScheduleAssignment[]

    @@index([depotId])
    @@index([employeeId])
    @@index([email])
    @@index([status])
    @@index([isAuthenticated])
    @@map("workers")
}

model Device {
    id       String       @id @default(uuid()) @db.Uuid
    deviceId String       @unique @db.VarChar(255) // Fingerprint único
    model    String?      @db.VarChar(100)
    platform String?      @db.VarChar(20) // iOS/Android
    appVersion String?    @db.VarChar(20)
    status   DeviceStatus @default(ACTIVE)

    // Sesión activa
    isLoggedIn     Boolean   @default(false)
    sessionToken   String?   @unique @db.VarChar(255)
    sessionExpiry  DateTime? @db.Timestamptz(3)
    lastActivityAt DateTime? @db.Timestamptz(3)

    lastUsedAt DateTime? @db.Timestamptz(3)
    createdAt  DateTime  @default(now()) @db.Timestamptz(3)
    updatedAt  DateTime  @updatedAt @db.Timestamptz(3)

    // Relación con worker
    workerId String @db.Uuid
    worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

    // Relaciones
    attendanceRecords AttendanceRecord[]

    @@index([workerId])
    @@index([deviceId])
    @@index([status])
    @@index([isLoggedIn])
    @@map("devices")
}

model Attendance {
    id         String    @id @default(uuid()) @db.Uuid
    date       DateTime  @db.Date // Solo fecha de la jornada
    entryTime  DateTime? @db.Timestamptz(3)
    exitTime   DateTime? @db.Timestamptz(3)
    totalHours Decimal?  @db.Decimal(5, 2) // Más preciso para horas
    isComplete Boolean   @default(false)
    notes      String?   @db.Text
    createdAt  DateTime  @default(now()) @db.Timestamptz(3)
    updatedAt  DateTime  @updatedAt @db.Timestamptz(3)

    // Relaciones
    workerId String @db.Uuid
    worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)
    depotId  String @db.Uuid
    depot    Depot  @relation(fields: [depotId], references: [id], onDelete: Restrict)

    // Registros individuales
    records AttendanceRecord[]

    @@index([workerId, date])
    @@index([depotId, date])
    @@index([date])
    @@index([isComplete])
    @@map("attendances")
}

model AttendanceRecord {
    id        String         @id @default(uuid()) @db.Uuid
    type      AttendanceType // ENUM nativo
    timestamp DateTime       @db.Timestamptz(3)
    status    RecordStatus   @default(PENDING) // ENUM nativo

    // Validaciones anti-fraude
    qrCodeUsed    String? @db.Text // Hash del QR (opcional)
    exceptionCode String? @db.VarChar(10) // Código excepción (opcional)
    photoPath     String  @db.Text // Path de la selfie
    photoMetadata Json? // JSONB para metadatos
    latitude      Decimal? @db.Decimal(10, 8)
    longitude     Decimal? @db.Decimal(11, 8)
    accuracy      Decimal? @db.Decimal(8, 2) // Precisión GPS

    // Validaciones del servidor
    validationErrors Json? // JSONB para errores estructurados
    fraudScore       Int? @db.SmallInt // 0-100
    processedAt      DateTime? @db.Timestamptz(3)

    // Datos offline
    createdOffline Boolean   @default(false)
    syncedAt       DateTime? @db.Timestamptz(3)

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    // Relaciones
    workerId     String     @db.Uuid
    worker       Worker     @relation(fields: [workerId], references: [id], onDelete: Cascade)
    deviceId     String     @db.Uuid
    device       Device     @relation(fields: [deviceId], references: [id], onDelete: Restrict)
    attendanceId String     @db.Uuid
    attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

    @@index([workerId, timestamp])
    @@index([attendanceId])
    @@index([status])
    @@index([type])
    @@index([fraudScore])
    @@map("attendance_records")
}

model AttendanceQRCode {
    id        String   @id @default(uuid()) @db.Uuid
    hash      String   @unique @db.VarChar(255) // SHA256
    timestamp DateTime @db.Timestamptz(3)
    expiresAt DateTime @db.Timestamptz(3)
    isUsed    Boolean  @default(false)
    usedAt    DateTime? @db.Timestamptz(3)
    createdAt DateTime @default(now()) @db.Timestamptz(3)

    // Relación con depot
    depotId String @db.Uuid
    depot   Depot  @relation(fields: [depotId], references: [id], onDelete: Cascade)

    @@index([depotId])
    @@index([expiresAt])
    @@index([isUsed])
    @@map("attendance_qr_codes")
}

model ExceptionCode {
    id        String                @id @default(uuid()) @db.Uuid
    code      String                @unique @db.VarChar(10) // Código corto
    status    ExceptionCodeStatus   @default(PENDING)
    expiresAt DateTime              @db.Timestamptz(3)
    usedAt    DateTime?             @db.Timestamptz(3)
    createdAt DateTime              @default(now()) @db.Timestamptz(3)
    updatedAt DateTime              @updatedAt @db.Timestamptz(3)

    // Relaciones
    workerId String @db.Uuid
    worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)
    adminId  String @db.Uuid
    admin    Admin  @relation(fields: [adminId], references: [id], onDelete: Cascade)

    @@index([workerId])
    @@index([adminId])
    @@index([status])
    @@index([expiresAt])
    @@map("exception_codes")
}

// ===== CONFIGURACIÓN Y HORARIOS =====

model FraudValidationConfig {
    id       String      @id @default(uuid()) @db.Uuid
    level    ConfigLevel // ENUM nativo
    entityId String?     @db.Uuid // depotId o workerId

    // Configuración como JSONB
    configJson Json // JSONB con toda la configuración

    // Metadata
    description String?  @db.Text
    version     Int      @default(1) @db.SmallInt
    isActive    Boolean  @default(true)

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@unique([level, entityId])
    @@index([level])
    @@index([isActive])
    @@map("fraud_validation_configs")
}

model FeatureFlag {
    id   String @id @default(uuid()) @db.Uuid
    name String @unique @db.VarChar(100)

    // Estado global
    enabled Boolean @default(true)

    // Configuración por entidad (JSONB)
    enabledForDepots   Json? // JSONB: ["depot1", "depot2"]
    enabledForWorkers  Json? // JSONB: ["worker1", "worker2"]
    disabledForDepots  Json? // JSONB: ["depot3"]
    disabledForWorkers Json? // JSONB: ["worker3"]

    // Metadata
    description String? @db.Text
    category    String? @db.VarChar(50)

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@index([name])
    @@index([enabled])
    @@map("feature_flags")
}

model WorkSchedule {
    id          String  @id @default(uuid()) @db.Uuid
    name        String  @db.VarChar(100)
    description String? @db.Text

    // Horarios (formato HH:mm)
    entryStart String @db.VarChar(5) // "21:00"
    entryEnd   String @db.VarChar(5) // "23:00"
    exitStart  String @db.VarChar(5) // "06:00"
    exitEnd    String @db.VarChar(5) // "08:00"

    // Tolerancias en minutos
    entryToleranceMinutes Int @default(15) @db.SmallInt
    exitToleranceMinutes  Int @default(15) @db.SmallInt

    // Días aplicables (JSONB array)
    daysOfWeek Json // JSONB: [1,2,3,4,5]

    // Configuración
    timezone String  @default("America/Guayaquil") @db.VarChar(50)
    isStrict Boolean @default(false)
    isActive Boolean @default(true)

    // Relaciones
    depotId     String?                    @db.Uuid
    depot       Depot?                     @relation(fields: [depotId], references: [id], onDelete: SetNull)
    assignments WorkerScheduleAssignment[]
    exceptions  ScheduleException[]

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@index([depotId])
    @@index([isActive])
    @@map("work_schedules")
}

model WorkerScheduleAssignment {
    id         String       @id @default(uuid()) @db.Uuid
    workerId   String       @db.Uuid
    worker     Worker       @relation(fields: [workerId], references: [id], onDelete: Cascade)
    scheduleId String       @db.Uuid
    schedule   WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Restrict)

    // Overrides opcionales
    customEntryStart     String? @db.VarChar(5)
    customEntryEnd       String? @db.VarChar(5)
    customExitStart      String? @db.VarChar(5)
    customExitEnd        String? @db.VarChar(5)
    customEntryTolerance Int? @db.SmallInt
    customExitTolerance  Int? @db.SmallInt
    customDaysOfWeek     Json? // JSONB override

    // Vigencia
    effectiveFrom DateTime  @db.Timestamptz(3) @default(now())
    effectiveTo   DateTime? @db.Timestamptz(3)

    // Metadata
    notes String? @db.Text

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@unique([workerId, scheduleId, effectiveFrom])
    @@index([workerId])
    @@index([scheduleId])
    @@index([effectiveFrom, effectiveTo])
    @@map("worker_schedule_assignments")
}

model ScheduleException {
    id         String          @id @default(uuid()) @db.Uuid
    scheduleId String          @db.Uuid
    schedule   WorkSchedule    @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

    // Excepción para fecha específica
    date   DateTime        @db.Date
    reason ExceptionReason // ENUM nativo

    // Horarios override
    entryStart String? @db.VarChar(5)
    entryEnd   String? @db.VarChar(5)
    exitStart  String? @db.VarChar(5)
    exitEnd    String? @db.VarChar(5)

    // Si false, no hay trabajo ese día
    isWorkingDay Boolean @default(true)

    // Metadata
    description String? @db.Text

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@unique([scheduleId, date])
    @@index([scheduleId])
    @@index([date])
    @@map("schedule_exceptions")
}

model FraudWeightConfig {
    id      String      @id @default(uuid()) @db.Uuid
    version Int         @default(1) @db.SmallInt

    // A qué entidad aplica
    level    ConfigLevel // ENUM nativo
    entityId String?     @db.Uuid

    // Pesos como JSONB
    weightsJson Json // JSONB: { "QR_EXPIRED": 30, ... }

    // Umbrales de decisión
    lowRiskThreshold    Int @default(20) @db.SmallInt
    mediumRiskThreshold Int @default(60) @db.SmallInt
    highRiskThreshold   Int @default(100) @db.SmallInt

    // Metadata
    effectiveFrom DateTime  @db.Timestamptz(3) @default(now())
    effectiveTo   DateTime? @db.Timestamptz(3)
    isActive      Boolean   @default(true)
    description   String?   @db.Text

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@unique([level, entityId, version])
    @@index([level])
    @@index([isActive])
    @@index([effectiveFrom, effectiveTo])
    @@map("fraud_weight_configs")
}

// ===== POLÍTICAS DE BREAKS (DESCANSOS) =====

model BreakPolicy {
    id      String      @id @default(uuid()) @db.Uuid
    version Int         @default(1) @db.SmallInt

    // A qué entidad aplica (cascading: GLOBAL → DEPOT → WORKER)
    level    ConfigLevel // ENUM nativo
    entityId String?     @db.Uuid // depotId o workerId (null para GLOBAL)

    // Configuración de breaks como JSONB
    // Formato: { "rules": [{ "minHours": 6, "breakMinutes": 30 }, ...] }
    breakRulesJson Json // JSONB con reglas de breaks

    // Metadata
    name        String  @db.VarChar(100)
    description String? @db.Text
    isActive    Boolean @default(true)

    createdAt DateTime @default(now()) @db.Timestamptz(3)
    updatedAt DateTime @updatedAt @db.Timestamptz(3)

    @@unique([level, entityId])
    @@index([level, isActive])
    @@index([entityId])
    @@map("break_policies")
}
