// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ===== ENUMS como STRINGS (SQLite compatible) =====

// AttendanceType: "ENTRY" | "EXIT"
// RecordStatus: "PENDING" | "ACCEPTED" | "REJECTED" | "SUSPICIOUS" 
// DeviceStatus: "ACTIVE" | "INACTIVE" | "BLOCKED"
// WorkerStatus: "ACTIVE" | "INACTIVE" | "SUSPENDED"
// AdminRole: "SUPER_ADMIN" | "SUPERVISOR" | "OPERATOR"
// LoginQRStatus: "PENDING" | "USED" | "EXPIRED"

// ===== AUTENTICACIÓN =====

model Admin {
    id        String   @id @default(cuid())
    username  String   @unique
    email     String   @unique
    password  String // Hash de contraseña
    firstName String
    lastName  String
    role      String   @default("SUPERVISOR") // SUPER_ADMIN | SUPERVISOR | OPERATOR
    isActive  Boolean  @default(true)
    lastLogin DateTime?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // QRs de login generados por este admin
    generatedLoginQRs WorkerLoginQR[]
    exceptionCodes    ExceptionCode[] // Códigos de excepción generados por este admin

    @@map("admins")
}

model WorkerLoginQR {
    id          String    @id @default(cuid())
    qrToken     String    @unique // Token único para el QR
    shortCode   String?   @unique // Código de 6 dígitos alternativo
    status      String    @default("PENDING") // PENDING | USED | EXPIRED
    expiresAt   DateTime? // Opcional, si quieres que expiren
    usedAt      DateTime?
    deviceInfo  String? // JSON con info del dispositivo que lo usó
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    // Relaciones
    workerId String
    worker   Worker @relation(fields: [workerId], references: [id])
    adminId  String
    admin    Admin  @relation(fields: [adminId], references: [id])

    @@map("worker_login_qrs")
}

// ===== ENTIDADES PRINCIPALES =====

model Depot {
    id              String   @id @default(cuid())
    name            String
    address         String?
    latitude        Float
    longitude       Float
    radius          Int      @default(100) // Radio en metros para geofencing
    secret          String   @unique // Clave criptográfica para códigos QR de asistencia
    secretUpdatedAt DateTime @default(now())
    isActive        Boolean  @default(true)
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    // Relaciones
    workers       Worker[]
    attendances   Attendance[]
    qrCodes       AttendanceQRCode[] // Renombrado para distinguir de login QRs
    workSchedules WorkSchedule[]     // Horarios del depot

    @@map("depots")
}

model Worker {
    id           String  @id @default(cuid())
    employeeId   String  @unique // ID empleado externo
    firstName    String
    lastName     String
    email        String? @unique
    phone        String?
    profilePhoto String? // URL/path de foto de referencia
    status       String  @default("ACTIVE") // ACTIVE | INACTIVE | SUSPENDED

    // Autenticación
    isAuthenticated Boolean   @default(false) // Si está logueado actualmente
    lastLoginAt     DateTime? // Última vez que se autenticó

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relación con depot
    depotId String
    depot   Depot  @relation(fields: [depotId], references: [id])

    // Relaciones
    devices            Device[]
    attendances        Attendance[]
    attendanceRecords  AttendanceRecord[]
    loginQRs           WorkerLoginQR[]             // QRs generados para este worker
    exceptionCodes     ExceptionCode[]             // Códigos de excepción generados para este worker
    scheduleAssignments WorkerScheduleAssignment[] // Horarios asignados

    @@map("workers")
}

model Device {
    id           String    @id @default(cuid())
    deviceId     String    @unique // Fingerprint único del dispositivo
    model        String?
    platform     String?   // iOS/Android
    appVersion   String?
    status       String    @default("ACTIVE") // ACTIVE | INACTIVE | BLOCKED
    
    // Sesión activa
    isLoggedIn      Boolean   @default(false) // Si tiene sesión activa
    sessionToken    String?   @unique // Token de sesión actual
    sessionExpiry   DateTime? // Cuándo expira la sesión (opcional)
    lastActivityAt  DateTime? // Última actividad registrada
    
    lastUsedAt DateTime?
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt

    // Relación con worker
    workerId String
    worker   Worker @relation(fields: [workerId], references: [id])

    // Relaciones
    attendanceRecords AttendanceRecord[]

    @@map("devices")
}

model Attendance {
    id         String    @id @default(cuid())
    date       DateTime  // Fecha de la jornada laboral
    entryTime  DateTime? // Hora de entrada
    exitTime   DateTime? // Hora de salida
    totalHours Float?    // Horas trabajadas calculadas
    isComplete Boolean   @default(false) // Si tiene entrada Y salida
    notes      String?   // Observaciones
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt

    // Relaciones
    workerId String
    worker   Worker @relation(fields: [workerId], references: [id])
    depotId  String
    depot    Depot  @relation(fields: [depotId], references: [id])

    // Registros individuales de entrada y salida
    records AttendanceRecord[]

    // NOTA: Removida restricción única para permitir múltiples turnos por día
    // @@unique([workerId, date])
    @@map("attendances")
}

model AttendanceRecord {
    id        String   @id @default(cuid())
    type      String   // ENTRY | EXIT
    timestamp DateTime // Momento exacto del registro
    status    String   @default("PENDING") // PENDING | ACCEPTED | REJECTED | SUSPICIOUS

    // Validaciones anti-fraude
    qrCodeUsed    String?  // Hash del código QR de asistencia utilizado (opcional para códigos de excepción)
    exceptionCode String?  // Código de excepción utilizado (opcional)
    photoPath     String  // Path de la selfie tomada
    photoMetadata String? // Metadatos de la foto (JSON)
    latitude      Float?  // GPS - Latitud
    longitude     Float?  // GPS - Longitud
    accuracy      Float?  // Precisión del GPS en metros

    // Validaciones del servidor
    validationErrors String?   // Errores de validación (JSON)
    fraudScore       Int?      // Puntuación de fraude (0-100)
    processedAt      DateTime? // Cuándo fue procesado por el servidor

    // Datos offline
    createdOffline Boolean   @default(false)
    syncedAt       DateTime? // Cuándo se sincronizó

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relaciones
    workerId     String
    worker       Worker     @relation(fields: [workerId], references: [id])
    deviceId     String
    device       Device     @relation(fields: [deviceId], references: [id])
    attendanceId String
    attendance   Attendance @relation(fields: [attendanceId], references: [id])

    @@map("attendance_records")
}

// Renombrado para distinguir de los QRs de login
model AttendanceQRCode {
    id        String    @id @default(cuid())
    hash      String    @unique // Hash SHA256 generado para asistencia
    timestamp DateTime  // Momento de generación
    expiresAt DateTime  // Cuándo expira (timestamp + 2 minutos)
    isUsed    Boolean   @default(false)
    usedAt    DateTime?
    createdAt DateTime  @default(now())

    // Relación con depot
    depotId String
    depot   Depot  @relation(fields: [depotId], references: [id])

    @@map("attendance_qr_codes")
}

model ExceptionCode {
    id        String   @id @default(cuid())
    code      String   @unique // Código de 6 dígitos
    status    String   @default("PENDING") // PENDING | USED | EXPIRED
    expiresAt DateTime // Cuándo expira el código
    usedAt    DateTime?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relaciones
    workerId String
    worker   Worker @relation(fields: [workerId], references: [id])
    adminId  String
    admin    Admin  @relation(fields: [adminId], references: [id])

    @@map("exception_codes")
}

// ===== NUEVAS TABLAS: CONFIGURACIÓN Y HORARIOS =====

// ConfigLevel: "GLOBAL" | "DEPOT" | "WORKER"

model FraudValidationConfig {
    id       String  @id @default(cuid())
    level    String  // "GLOBAL" | "DEPOT" | "WORKER"
    entityId String? // depotId o workerId (null para global)

    // Configuración como JSON
    configJson String // JSON con toda la configuración de validaciones

    // Metadata
    description String?
    version     Int     @default(1)
    isActive    Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([level, entityId])
    @@map("fraud_validation_configs")
}

model FeatureFlag {
    id   String  @id @default(cuid())
    name String  @unique // "PHOTO_VALIDATION", "PATTERN_VALIDATION", etc.

    // Estado global
    enabled Boolean @default(true)

    // Configuración por entidad (JSON)
    enabledForDepots  String? // JSON: ["depot1", "depot2"]
    enabledForWorkers String? // JSON: ["worker1", "worker2"]
    disabledForDepots  String? // JSON: ["depot3"]
    disabledForWorkers String? // JSON: ["worker3"]

    // Metadata
    description String?
    category    String? // "VALIDATION", "FEATURE", etc.

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("feature_flags")
}

model WorkSchedule {
    id          String  @id @default(cuid())
    name        String  // "Turno Nocturno", "Turno Diurno"
    description String?

    // Horarios (formato HH:mm en timezone especificado)
    entryStart String // "21:00"
    entryEnd   String // "23:00"
    exitStart  String // "06:00"
    exitEnd    String // "08:00"

    // Tolerancias en minutos
    entryToleranceMinutes Int @default(15)
    exitToleranceMinutes  Int @default(15)

    // Días aplicables (1=Lun, 2=Mar, ..., 7=Dom)
    daysOfWeek String // JSON: [1,2,3,4,5]

    // Configuración
    timezone String  @default("America/Guayaquil")
    isStrict Boolean @default(false) // true = rechaza fuera horario, false = marca sospechoso
    isActive Boolean @default(true)

    // Relaciones
    depotId     String?
    depot       Depot?                     @relation(fields: [depotId], references: [id])
    assignments WorkerScheduleAssignment[]
    exceptions  ScheduleException[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("work_schedules")
}

model WorkerScheduleAssignment {
    id         String       @id @default(cuid())
    workerId   String
    worker     Worker       @relation(fields: [workerId], references: [id])
    scheduleId String
    schedule   WorkSchedule @relation(fields: [scheduleId], references: [id])

    // Overrides opcionales (deja null para usar config del schedule)
    customEntryStart         String?
    customEntryEnd           String?
    customExitStart          String?
    customExitEnd            String?
    customEntryTolerance     Int?
    customExitTolerance      Int?
    customDaysOfWeek         String? // JSON override

    // Vigencia
    effectiveFrom DateTime  @default(now())
    effectiveTo   DateTime?

    // Metadata
    notes String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([workerId, scheduleId, effectiveFrom])
    @@map("worker_schedule_assignments")
}

model ScheduleException {
    id         String       @id @default(cuid())
    scheduleId String
    schedule   WorkSchedule @relation(fields: [scheduleId], references: [id])

    // Excepción para fecha específica
    date   DateTime // Fecha específica (año-mes-día)
    reason String   // "HOLIDAY", "SPECIAL_EVENT", "OVERTIME", "MAINTENANCE"

    // Horarios override (null = usar horario normal)
    entryStart String?
    entryEnd   String?
    exitStart  String?
    exitEnd    String?

    // Si false, no hay trabajo ese día
    isWorkingDay Boolean @default(true)

    // Metadata
    description String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([scheduleId, date])
    @@map("schedule_exceptions")
}

model FraudWeightConfig {
    id      String @id @default(cuid())
    version Int    @default(1)

    // A qué entidad aplica
    level    String  // "GLOBAL" | "DEPOT" | "WORKER"
    entityId String? // depotId o workerId (null para global)

    // Pesos como JSON
    weightsJson String // JSON: { "QR_EXPIRED": 30, "LOCATION_OUT_OF_RANGE": 35, ... }

    // Umbrales de decisión
    lowRiskThreshold    Int @default(20)  // 0-20 = ACCEPTED
    mediumRiskThreshold Int @default(60)  // 21-60 = SUSPICIOUS
    highRiskThreshold   Int @default(100) // 61+ = REJECTED

    // Metadata
    effectiveFrom DateTime  @default(now())
    effectiveTo   DateTime?
    isActive      Boolean   @default(true)
    description   String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([level, entityId, version])
    @@map("fraud_weight_configs")
}